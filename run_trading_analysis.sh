#!/bin/bash
# ==============================================================================
# 高级杠杆交易决策系统 - 快速启动脚本
# ==============================================================================
# 
# 使用方法：
#   1. 直接运行（使用默认参数）：
#      bash run_trading_analysis.sh
#   
#   2. 修改下面的参数后运行：
#      编辑本文件 → 修改参数 → 保存 → 运行
#
# ==============================================================================

# ================================ 参数配置 ====================================

# 💰 本金（USDT）
# 说明：你准备投入多少U进行交易
# 范围：任意正数，建议 100-10000
# 示例：1000 表示投入1000 USDT
CAPITAL=1000

# 📊 杠杆倍数
# 说明：放大多少倍的交易资金
# 范围：1-125（实际交易所限制可能不同）
# 建议：
#   - 新手：1-5倍（保守）
#   - 进阶：5-10倍（中等）
#   - 老手：10-20倍（激进）
#   - 危险：>20倍（不建议）
# 示例：10 表示10倍杠杆
LEVERAGE=10

# ⚠️ 风险比例（%）
# 说明：单笔交易愿意承受的最大损失占本金的百分比
# 范围：0.5-5.0
# 建议：
#   - 保守：1.0%（连续止损100次才亏完）
#   - 平衡：2.0%（连续止损50次才亏完）
#   - 激进：3.0%（连续止损33次才亏完）
# 示例：2.0 表示单笔最多损失本金的2%
RISK=2.0

# 🛑 止损比例（%）
# 说明：价格反向移动多少百分比就止损离场
# 范围：0.5-5.0
# 建议：
#   - 紧密止损：1.0-1.5%（快速止损，但容易被扫）
#   - 平衡止损：2.0%（推荐）
#   - 宽松止损：3.0-5.0%（给更多空间，但风险大）
# 注意：止损越小，仓位越大；止损越大，仓位越小
# 示例：2.0 表示价格反向2%就止损
STOP_LOSS=2.0

# 🪙 交易对（支持多个币种，用空格分隔）
# 说明：要分析哪些币种
# 格式：币种+USDT（必须大写）
# 常见：
#   - BTCUSDT  (比特币)
#   - ETHUSDT  (以太坊)
#   - BNBUSDT  (币安币)
#   - SOLUSDT  (Solana)
#   - ADAUSDT  (卡尔达诺)
#   - DOGEUSDT (狗狗币)
# 示例：BTCUSDT ETHUSDT 表示同时分析比特币和以太坊
SYMBOLS="BTCUSDT ETHUSDT"

# ==============================================================================
# 以下是自动计算的信息（无需修改）
# ==============================================================================

# 计算有效资金
EFFECTIVE_CAPITAL=$((CAPITAL * LEVERAGE))

# 计算单笔最大损失
MAX_LOSS=$(echo "scale=2; $CAPITAL * $RISK / 100" | bc)

# 计算爆仓距离（近似）
LIQUIDATION_DISTANCE=$(echo "scale=2; 100 / $LEVERAGE" | bc)

# ==============================================================================
# 显示配置信息
# ==============================================================================

echo ""
echo "════════════════════════════════════════════════════════════════════════════════"
echo "🚀 高级杠杆交易决策系统"
echo "════════════════════════════════════════════════════════════════════════════════"
echo ""
echo "📋 交易配置："
echo "  💰 本金：            $CAPITAL USDT"
echo "  📊 杠杆：            ${LEVERAGE}x"
echo "  💵 有效资金：        $EFFECTIVE_CAPITAL USDT (本金 × 杠杆)"
echo "  ⚠️  风险比例：        ${RISK}%"
echo "  🛑 止损：            ${STOP_LOSS}%"
echo "  🪙 交易对：          $SYMBOLS"
echo ""
echo "📊 风险评估："
echo "  💀 单笔最大损失：    约 $MAX_LOSS USDT (${RISK}%本金)"
echo "  ⚡ 爆仓距离：        约 ${LIQUIDATION_DISTANCE}% (价格反向${LIQUIDATION_DISTANCE}%爆仓)"
echo "  🎯 止盈计划：        2:1, 3:1, 4:1 风险收益比（自动计算）"
echo ""
echo "════════════════════════════════════════════════════════════════════════════════"
echo ""

# 风险警告
if (( $(echo "$LEVERAGE > 20" | bc -l) )); then
    echo "🔴 警告：杠杆>20倍，风险极高！建议降低杠杆"
    echo ""
fi

if (( $(echo "$RISK > 3" | bc -l) )); then
    echo "🔴 警告：单笔风险>3%，可能导致快速亏损！建议降低风险"
    echo ""
fi

if (( $(echo "$STOP_LOSS < 1" | bc -l) )); then
    echo "⚠️  提示：止损<1%，可能容易被扫止损"
    echo ""
fi

# 确认执行
echo "📌 按 Enter 继续分析，Ctrl+C 取消..."
read -r

# ==============================================================================
# 执行分析
# ==============================================================================

echo ""
echo "🔄 启动分析..."
echo ""

# 统计变量
declare -A results
total_count=0
long_count=0
short_count=0
hold_count=0

# 循环分析每个币种
symbol_array=($SYMBOLS)
symbol_total=${#symbol_array[@]}

for i in "${!symbol_array[@]}"; do
    SYMBOL="${symbol_array[$i]}"
    current=$((i + 1))
    
    echo ""
    echo "════════════════════════════════════════════════════════════════════════════════"
    echo "📊 [$current/$symbol_total] 分析 $SYMBOL"
    echo "════════════════════════════════════════════════════════════════════════════════"
    echo ""
    
    # 执行分析并捕获输出
    output=$(python advanced_trading_system.py \
        --capital "$CAPITAL" \
        --leverage "$LEVERAGE" \
        --risk "$RISK" \
        --stop-loss "$STOP_LOSS" \
        --symbol "$SYMBOL" 2>&1)
    
    echo "$output"
    
    # 提取决策结果（从"最终决策"部分）
    action=$(echo "$output" | grep -A 2 "【最终决策】" | grep "操作:" | awk '{print $NF}')
    
    if [ -n "$action" ]; then
        results[$SYMBOL]=$action
        total_count=$((total_count + 1))
        
        case $action in
            LONG)
                long_count=$((long_count + 1))
                ;;
            SHORT)
                short_count=$((short_count + 1))
                ;;
            HOLD)
                hold_count=$((hold_count + 1))
                ;;
        esac
    fi
    
    # 如果不是最后一个，等待一下
    if [ $current -lt $symbol_total ]; then
        echo ""
        echo "⏳ 等待2秒后继续..."
        sleep 2
    fi
done

# ==============================================================================
# 综合对比
# ==============================================================================

if [ $total_count -gt 1 ]; then
    echo ""
    echo "════════════════════════════════════════════════════════════════════════════════"
    echo "📊 综合对比分析"
    echo "════════════════════════════════════════════════════════════════════════════════"
    echo ""
    echo "📈 决策统计："
    echo "  总计分析：$total_count 个币种"
    echo "  🟢 做多(LONG)：  $long_count 个"
    echo "  🔴 做空(SHORT)： $short_count 个"
    echo "  ⚪ 观望(HOLD)：  $hold_count 个"
    echo ""
    echo "💼 各币种决策："
    for symbol in "${!results[@]}"; do
        action="${results[$symbol]}"
        case $action in
            LONG)
                emoji="🟢"
                ;;
            SHORT)
                emoji="🔴"
                ;;
            HOLD)
                emoji="⚪"
                ;;
            *)
                emoji="❓"
                ;;
        esac
        printf "  %s %-10s %s\n" "$emoji" "$symbol" "$action"
    done
    echo ""
    
    # 推荐建议
    echo "💡 交易建议："
    if [ $long_count -gt 0 ] && [ $short_count -gt 0 ]; then
        echo "  ⚠️  多空信号混杂，建议谨慎操作"
    elif [ $long_count -gt 0 ]; then
        echo "  ✅ 有做多机会，优先选择置信度高的币种"
    elif [ $short_count -gt 0 ]; then
        echo "  ✅ 有做空机会，优先选择置信度高的币种"
    else
        echo "  ⚠️  当前无明确机会，建议观望"
    fi
    echo ""
fi

# ==============================================================================
# 结束
# ==============================================================================

echo ""
echo "════════════════════════════════════════════════════════════════════════════════"
echo "✅ 所有分析完成！"
echo "════════════════════════════════════════════════════════════════════════════════"
echo ""
echo "💡 提示："
echo "  - 如需修改参数，编辑此脚本文件"
echo "  - 如需分析其他币种，修改 SYMBOLS 参数"
echo "  - 建议先用小资金测试"
echo "  - 可同时分析多个币种：SYMBOLS=\"BTCUSDT ETHUSDT BNBUSDT\""
echo ""
